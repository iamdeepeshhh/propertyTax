<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <title>Assessment Register - Combined Header</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap" rel="stylesheet">
    <style>
        table {
          border-collapse: collapse;
          width: 100%;
          border: 1px solid #000; /* full outer border */
          table-layout: fixed;
        }

        th, td {
          border: 1px solid #000; /* uniform grid lines */
          text-align: center;
          padding: 4px 3px;
          vertical-align: middle;
          line-height: 1.1;
        }

        th {
          font-weight: 600;
          background: #fff; /* no header color */
        }

        /* vertical headers */
        .v {
          writing-mode: vertical-rl;
          transform: rotate(180deg);
          white-space: normal;
          word-break: break-word;
          font-size: 11px;
          line-height: 1.1;
          padding: 4px 2px;
          height: 100px;
          width: 30px;
          overflow: hidden;
        }

        th.p1, td.p1,
        th.p2, td.p2 {
          background: #fff;
          border: 1px solid #000; /* reinforce edge consistency */
        }

        /* Seam column (visual divider) */
        .seam, td.seam, th.seam {
          width: 12px;
          min-width: 12px;
          background: repeating-linear-gradient(
            90deg,
            #000 0 1px,
            transparent 1px 12px
          );
          border-left: 1px solid #000;
          border-right: 1px solid #000;
          padding: 0;
        }

        body {
          font-family: 'Noto Sans Devanagari', Arial, sans-serif;
          margin: 20px;
          font-size: 14px;
        }

        .controls {
          position: sticky;
          top: 0;
          background: #fff;
          padding: 10px;
          display: flex;
          gap: 10px;
          z-index: 10;
          border-bottom: 1px solid #ccc;
        }
        button {
          background: #004aad;
          color: #fff;
          border: none;
          padding: 8px 14px;
          border-radius: 6px;
          cursor: pointer;
        }
        button.secondary { background: #0e7c3a; }

        .report-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          text-align: center;
          width: 100%;
          margin: 0 auto 5px auto;
          padding: 0;
          gap: 10px;
        }

        .property-no .prop-line {
          border-bottom: 1px solid #000;
          padding: 1px 0; /* tighter to reduce row height */
        }

        .property-no .prop-line:last-child {
          border-bottom: none; /* remove divider after last one */
        }

       .report-header img {
          height: 90px;
          width: 90px;
          object-fit: contain;
          margin: 0;
          padding: 0;
        }

        .report-header div {
          flex: 1;
          text-align: center;
        }

        .report-header h1 {
          color: red;
          font-size: 22px;
          margin: 0 0 4px 0;
        }

        .report-header p {
          margin: 2px 0;
          font-size: 14px;
          line-height: 1.3;
        }
        .report-header h1, .report-header p {
          margin: 0;
          padding: 0;
          font-size: 20px;
        }
        .report-header h1 {
          color: red;
          font-size: 22px;
        }

        tr.divider-row td {
          border-top: 2px double #000;
          border-bottom: none;
          background: #fff;
          height: 6px;
          padding: 0;
        }

        .column-numbers th {
          background: rgb(136, 214, 250); /* column index band */
          font-size: 11px;
          font-weight: bold;
          border: 1px solid #000;
          text-align: center;
        }

        /* Ensure header gridlines are always visible */
        .reportTable thead th {
          border: 1px solid #000 !important;
          border-color: #000 !important;
        }
        .reportTable thead tr { border-bottom: 1px solid #000 !important; }

        /* No special color for group headers */
        th.group { background: #fff; }

        /* üîπ CSS Counters for Column Numbers */
        tr.column-numbers {
          /* 1. Reset counters. The P2 reset value will be overridden by an inline style. */
          counter-reset: counterP1 0 counterP2 0;
        }

        /* 2. Increment P1 counter for p1 columns */
        tr.column-numbers th.p1 {
          counter-increment: counterP1;
        }
        /* 2. Increment P2 counter for p2 columns */
        tr.column-numbers th.p2 {
          counter-increment: counterP2;
        }

        /* 3. Display counters using ::before */
        tr.column-numbers th.p1::before {
          content: counter(counterP1);
        }
        tr.column-numbers th.p2::before {
          content: counter(counterP2);
        }

        /* Do not number the P2 serial column */
        tr.column-numbers th.p2.p2-serial { counter-increment: none; }
        tr.column-numbers th.p2.p2-serial::before { content: ""; }
        /* Note: .seam columns won't be incremented or display content, which is correct. */


        td.property-no {
          line-height: 1.15;
          text-align: center;
          vertical-align: middle;
          white-space: pre-line; /* allows line breaks (
) */
          font-weight: 600;
          font-size: 11px;
          padding: 2px 3px;
        }

        td.multi-line {
          text-align: center;
          vertical-align: middle;
          line-height: 1.0;
          white-space: pre-line; /* allows or <br> line breaks */
          font-size: 10px;
          font-weight: 500;
          padding: 1px 2px;
        }

        /* üîπ Optional: light background header strip like your screenshot */
        tr.highlight-row td {
          background-color: #dff0ff;
          font-weight: bold;
          border-top: 2px solid #000;
          border-bottom: 2px solid #000;
        }

       td.description-cell {
          vertical-align: middle;
          text-align: center;
          padding: 2px 0;
          font-size: 12px;
          border-left: 1px solid #000;
          border-right: 1px solid #000;
        }

      /* üîπ Each usage/floor block inside that cell */
      .description-block {
        border-bottom: 1px solid #000;
        padding: 4px 2px;
        line-height: 1.3;
        white-space: pre-line;
      }

      .description-block:last-child {
        border-bottom: none; /* remove line on last */
      }

      /* üîπ Optional blue highlight row (like your header strip) */
      tr.highlight td {
        background-color: #d8efff;
        font-weight: bold;
      }

      /* ‚úÖ Ensure Part 1 and Part 2 columns match perfectly */
table.reportTable {
  table-layout: fixed;
  width: 100%;
}

/* Give both parts equal cell sizing */
.p1, .p2 {
  width: auto;
  min-width: 30px;
  max-width: 100px;
  word-wrap: break-word;
}

        /* Optional: make text wrap identically (tighter) */
        .p1, .p2, .v {
  line-height: 1.15;
  padding: 2px 3px;
  vertical-align: middle;
}
        /* Tighter Part 1 cells so height follows content */
        th.p1, td.p1 {
          padding: 2px 3px;
          line-height: 1.12;
        }
        /* Tighter Part 2 cells to match height tightening */
        th.p2, td.p2 {
          padding: 2px 3px;
          line-height: 1.12;
        }

/* Force vertical alignment across both sides */
tr td, tr th {
  vertical-align: middle;
}

th, td {
  font-size: 14px;          /* slightly smaller text */
  padding: 2px 3px;      /* slightly more breathing room */
  line-height: 1.15        /* reduce vertical space */
  vertical-align: middle;
}

/* Widen the Usage/Floor/Owner, Tenant columns to avoid wrapping */
.usage-cell {
  min-width: 170px;
}

/* Broader important columns */
th.property-no, td.property-no { min-width: 90px; }
th.owner-name, td.owner-name   { min-width: 120px; }
th.usage-type, td.usage-type   { min-width: 90px; }
th.zone-no, td.zone-no         { min-width: 60px; }
th.tax-col, td.tax-col         { min-width: 55px; }

/* Keep numeric tax columns compact */
th[class*="p1"], th[class*="p2"], td[class*="p1"], td[class*="p2"] {
  text-align: center;
  min-width: 45px;
}

/* Vertical header width so Marathi fits properly */
th.v {
  width: 36px;
  white-space: normal;
  word-break: break-word;
}

/* Allow wide layout with smooth scroll on-screen */
#reportContainer {
  overflow-x: auto;
  width: 100%;
}

/* Optional: visually balance all columns horizontally */
table.reportTable {
  border-spacing: 0;
  table-layout: fixed;
}
.reportTable td.p1,
.reportTable td.p2 {
  padding: 4px 5px;
  font-size: 12px;
  line-height: 1.2;
}

.description-block {
  padding: 0.5px 0;
  line-height: 1.05;
}


.partition-row td {
  height: 30px;
  background: #fafafa;
}
.total-row td {
  height: auto !important;
  padding: 2px 3px !important;
  line-height: 1.12 !important;
  font-size: 12px !important;
  vertical-align: middle !important;
  background: #fff !important;
  border: 1px solid #000 !important;
}
.center-header {
  flex: 1;
  text-align: center;
  line-height: 1.3;
}

.center-header h1 {
  font-size: 22px;
  color: red;
  margin: 0;
}

.center-header p {
  font-size: 14px;
  margin: 2px 0;
}

/* Tighten header to table */
.report-header + div,
.report-header + table {
  margin-top: 2px !important;
}
.p2-flex-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 40px;
  width: 100%;
  font-size: 14px;
}

.p2-bullets {
  flex: 1.2;
  text-align: left;
}

.p2-bullets ul {
  list-style-type: disc;
  list-style-position: inside;
  margin: 4px 0 0 10px;
  padding: 0;
  line-height: 1.3;
}

.p2-sign {
  text-align: center;
  font-size: 15px;
  line-height: 1.4;
  margin-top: 10px;
}

.p2-sign .sig-line {
  text-decoration: none;
  border-top: 2px solid #000;
  width: 60%;
  margin: 0 auto 4px auto;
}

.p2-sign p {
  margin: 4px 0;
}

.p2-sign .tatha {
  text-align: center;
  margin: 6px 0;
}

        @media print {
  .controls { display: none !important; }
.report-header {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important;
    gap: 20px !important;
    width: 100% !important;
    margin: 10px auto !important;
    margin-bottom: 4px !important;

  }

  .report-header img {
    height: 90px !important;
    margin: 0 !important;
  }

  .report-header div {
    flex: 1 !important;
    text-align: center !important;
  }
  header.report-header, thead {
    display: table-header-group;
  }

  tfoot { display: table-footer-group; }

  /* Hide unnecessary parts */
  body.print1 .p2,
  body.print1 .seam {
    display: none !important;
  }

  body.print2 .p1,
  body.print2 .seam {
    display: none !important;
  }

.reportTable td.p1,
  .reportTable td.p2 {
    padding: 1px 2px !important;
  line-height: 1.1 !important;
  font-size: 10.5px !important;
  }

  .description-block {
    padding: 1px 0 !important;
    line-height: 1.1 !important;
  }

  .reportTable th.v {
    line-height: 1.05 !important;
    font-size: 10px !important;
    height: 90px !important;
  }

  .partition-row td {
    height: 16px !important;
    background: #f9f9f9 !important;

  }

  /* ‚úÖ Ensure container and tables are visible in PDF */
  #reportContainer {
    display: block !important;
    visibility: visible !important;
  }

  table.reportTable {
    display: table !important;
    width: 100% !important;
  }

  /* ‚úÖ Continuous flow (no extra blank pages) */
  div[style*="page-break-after"] {
    page-break-after: avoid !important;
  }

  @page {
    size: A3 landscape;
    margin: 10mm;
  }
  /* Remove scrollbars and borders in print */
  html, body { overflow: visible !important; }
  #reportContainer { overflow: visible !important; }
  .reportWrapper {
    overflow: visible !important;
    max-height: none !important;
    border: none !important;
    box-shadow: none !important;
  }
  .reportWrapper::-webkit-scrollbar { display: none !important; }
  .reportWrapper table.reportTable {
    width: 100% !important;
    min-width: 100% !important;
  }
}
        /* ‚úÖ Enable horizontal + vertical scrolling for large tables */
.reportWrapper {
  overflow-x: auto;
  overflow-y: auto;
  max-width: 100%;
  max-height: 85vh;     /* show large part of table before scrolling */
  border: 1px solid #ccc;
  margin-bottom: 20px;
}

 .p2-flex-row {
    gap: 25px !important;
    font-size: 13px !important;
  }
  .p2-bullets ul {
    margin-left: 8px !important;
    line-height: 1.2 !important;
  }
  .p2-sign {
    text-align: right !important;
    font-size: 13px !important;
  }
/* Ensure tables inside scroll area don‚Äôt shrink */
.reportWrapper table {
  width: max-content;    /* table grows as wide as its content */
  min-width: 100%;       /* but not smaller than full width */
}

/* No boxes on the post-totals P1/P2 row; keep seam visible */
.reportTable.no-grid { border: none !important; }
.reportTable.no-grid td:not(.seam) { border: none !important; }
.reportWrapper.no-outline { border: none !important; box-shadow: none !important; }

/* Tighten bullet spacing for the P2 note on totals page */
.reportTable.no-grid td.p2 ul {
  list-style: none;
  margin: 2px 0 !important;
  padding-left: 0 !important;
}
.reportTable.no-grid td.p2 ul li {
  position: relative;
  padding-left: 12px !important; /* bring text closer to bullet */
  margin: 2px 0 !important;
}
.reportTable.no-grid td.p2 ul li::before {
  content: '‚Ä¢';
  position: absolute;
  left: 0;
  top: 0;
}
/* Center text and reduce padding/margins on last row */
.reportTable.no-grid td.p2 { padding-left: 6px !important; }
.reportTable.no-grid td.p1 .sig { text-align: center; }
.reportTable.no-grid td.p1 .sig p,
.reportTable.no-grid td.p2 .authority p,
.reportTable.no-grid td.p2 p { margin: 2px 0 !important; }
.reportTable.no-grid td.p2 .authority { text-align: center; }




/* ‚úÖ Ultra-compact layout for ‡§µ‡§æ‡§™‡§∞ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ / ‡§Æ‡§ú‡§≤‡§æ / ‡§Æ‡§æ‡§≤‡§ï / ‡§≠‡§æ‡§°‡•á‡§ï‡§∞‡•Ç */
td.description-cell.usage-cell {
  padding: 0 !important;           /* no extra space top/bottom */
  line-height: 0.95 !important;    /* tighten lines further */
}

td.description-cell.usage-cell .description-block {
  padding: 0 !important;           /* remove padding inside each block */
  margin: 0 !important;            /* remove gap between lines */
  line-height: 0.95 !important;    /* compact text spacing */
}

td.description-cell.usage-cell .description-block:last-child {
  margin-bottom: -1px !important;
}


/* Lighten and shrink divider line between items */
td.description-cell.usage-cell .description-block div[style*="border-top"] {
  border-top: 1px solid rgba(0,0,0,0.15) !important; /* thinner and lighter line */
  width: 45% !important;                             /* shorter divider */
  margin: 0 auto !important;                         /* almost no gap around */
}

.property-no .prop-line:not(:last-child) {
  margin-bottom: 4px;
}

    </style>
</head>
<body>
<div class="controls">
    <button onclick="printPart(1)">üñ®Ô∏è Print Part 1 (‡§∏‡•Å‡§®‡§æ‡§µ‡§£‡•Ä ‡§Ü‡§ß‡•Ä‡§ö‡•á ‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§)</button>
    <button class="secondary" onclick="printPart(2)">üñ®Ô∏è Print Part 2 (‡§∏‡•Å‡§®‡§æ‡§µ‡§£‡•Ä ‡§®‡§Ç‡§§‡§∞‡§ö‡•á ‡§µ ‡§Ö‡§™‡•Ä‡§≤ ‡§®‡§Ç‡§§‡§∞)</button>
</div>

<!-- Main Header (first appearance) -->
<header class="report-header" id="mainHeader">
    <img class="councilLogoLeft" src="https://example.com/default-image.png" alt="Left Council Logo" />

    <div class="center-header">
        <h1 class="councilName">‡§®‡§ó‡§∞ ‡§™‡§∞‡§ø‡§∑‡§¶, Sitename / Municipal Council Sitename</h1>
        <p>
            ‡§Æ‡§π‡§æ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞ ‡§®‡§ó‡§∞‡§™‡§æ‡§≤‡§ø‡§ï‡§æ ‡§≤‡•á‡§ñ‡§æ ‡§∏‡§Ç‡§π‡§ø‡§§‡§æ ‡•ß‡•Ø‡•≠‡•ß (‡§®‡§Æ‡•Å‡§®‡§æ ‡•™‡•© ‡§®‡§ø‡§Ø‡§Æ ‡•≠‡•™ ‡§™‡§π‡§æ) /
            The Maharashtra Municipal Account Code 1971 (Form No. 43 See Rule No. 74)
        </p>
        <p>
            <span class="yearRange"></span>
            ‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§Ç‡§ï‡§∞‡§ø‡§§‡§æ ‡§á‡§Æ‡§æ‡§∞‡§§‡•Ä ‡§µ ‡§ú‡§Æ‡§ø‡§®‡•Ä‡§Ç‡§ö‡•ç‡§Ø‡§æ ‡§Ü‡§ï‡§æ‡§∞‡§£‡•Ä‡§∏ ‡§™‡§æ‡§§‡•ç‡§∞ ‡§Ö‡§∏‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§≤‡§Æ‡§§‡•ç‡§§‡§æ‡§Ç‡§ö‡•Ä ‡§Ü‡§ï‡§æ‡§∞‡§£‡•Ä ‡§∏‡•Ç‡§ö‡•Ä /
            Assessment List of Buildings and Lands Liable to Taxation for the Year of
            <span class="yearRangeEnglish"></span>
        </p>
    </div>

    <img class="councilLogoRight" alt="Right Council Logo" style="display:none;" />
</header>


<!-- Placeholder container for chunks -->
<div id="reportContainer"></div>

<script>
    // üîπ Global store for dynamic tax configurations
    window.dynamicTaxConfigs = [];
let globalYearRange = '';
    // Unit usage id -> local name map
    window.unitUsageLocal = new Map();
    // Occupancy id -> local name map
    window.occupancyLocal = new Map();

    async function fetchUnitUsageMap() {
      try {
        const res = await fetch('/3g/getAllUnitUsageTypes');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const rows = await res.json();
        rows.forEach(r => { if (r && r.id != null) window.unitUsageLocal.set(Number(r.id), r.localName || ''); });
      } catch (e) { console.warn('Failed to load unit usage types', e); }
    }

    async function fetchOccupancyMap() {
      try {
        const res = await fetch('/3g/occupancyMasters');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const rows = await res.json();
        rows.forEach(r => { if (r && r.id != null) window.occupancyLocal.set(Number(r.id), r.localName || r.standardName || ''); });
      } catch (e) { console.warn('Failed to load occupancy types', e); }
    }

    // üîπ Fetch only dynamic tax column names
    async function fetchDynamicTaxColumns() {
      try {
        const res = await fetch("/3g/reportTaxConfigs?template=ASSESSMENT_REGISTER");
        if (!res.ok) throw new Error(`HTTP ${res.status} fetching tax configs`);

        const configs = await res.json();

        // Sort by sequence and store globally
        configs.sort((a, b) => a.sequenceI - b.sequenceI);
        window.dynamicTaxConfigs = configs;

        console.log("‚úÖ Dynamic tax headers loaded:", configs.map(c => c.localNameVc));
      } catch (err) {
        console.error("‚ùå Failed to fetch tax configs:", err);
        alert("Error: Could not load dynamic tax columns. Report may be incorrect.");
      }
    }

    // Abbreviate floor names to compact labels (e.g., Ground -> GF, Basement -> B)
    function abbreviateFloor(value) {
      if (value == null) return '‚Äî';
      const raw = String(value).trim();
      if (raw.length === 0) return '‚Äî';
      const s = raw.toLowerCase();

      // Handle composites like "Basement 1", "Basement-2"
      if (s.startsWith('basement')) {
        const n = s.replace(/[^0-9]/g, '');
        return 'B' + (n || '');
      }
      if (s.startsWith('ground')) return 'GF';
      if (s === 'g' || s === 'g.f.' || s === 'g f' || s === 'gf') return 'GF';
      if (s.startsWith('loft')) return 'L';
      if (s.startsWith('mezz')) return 'M';
      if (s.startsWith('stilt')) return 'ST';
      if (s.startsWith('terrace')) return 'T';
      if (s.startsWith('roof')) return 'RF';
      if (s.startsWith('open')) return 'O';
      if (s.startsWith('other')) return 'OT';

      // Words to numbers mapping
      const words = {
        'first': '1', 'second': '2', 'third': '3', 'fourth': '4', 'fifth': '5',
        'sixth': '6', 'seventh': '7', 'eighth': '8', 'ninth': '9', 'tenth': '10'
      };
      if (words[s]) return words[s];

      // Numeric floor like "1", "1st", "2nd", etc.
      const m = s.match(/^(\d+)(st|nd|rd|th)?(\s*floor)?$/);
      if (m) return `${parseInt(m[1], 10)}`;

      // Default to first letter uppercased
      return raw.charAt(0).toUpperCase();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // Run council details fetch in parallel
      fetchCouncilDetails();

    try {
      const resDates = await fetch('/3g/getAllAssessmentDates');
      if (!resDates.ok) throw new Error('HTTP ' + resDates.status);
      const data = await resDates.json();
      if (data && data.length > 0) {
        const currentAssessmentDate = data[0].currentassessmentdate;
        const year = parseInt((currentAssessmentDate||'').split('-')[0]);
        const endYear = year + 3;
        const toDev = (s)=>{
          const map=['‡•¶','‡•ß','‡•®','‡•©','‡•™','‡•´','‡•¨','‡•≠','‡•Æ','‡•Ø'];
          return String(s).replace(/\d/g, ch => map[Number(ch)]);
        };
        const startDev = toDev(String(year));
        const startNextDev = toDev(String((year+1)%100).padStart(2,'0'));
        const endDev = toDev(String(endYear));
        const endNextDev = toDev(String((endYear+1)%100).padStart(2,'0'));
        const yearRangeMarathi = `‡§µ‡§∞‡•ç‡§∑ ${startDev}-${startNextDev} ‡§§‡•á ${endDev}-${endNextDev}`;
        const englishRange = `${year}-${(year + 1).toString().slice(-2)} to ${endYear}-${(endYear + 1).toString().slice(-2)}`;
        const yrEl = document.querySelector('.yearRange');
        const yrEnEl = document.querySelector('.yearRangeEnglish');
        if (yrEl) yrEl.textContent = yearRangeMarathi;
        if (yrEnEl) yrEnEl.textContent = englishRange;
      }
    } catch(err) {
      console.error('Error fetching assessment dates:', err);
    }
      // 1. Load usage/occupancy maps and tax configurations first
      await fetchUnitUsageMap();
      await fetchOccupancyMap();
      await fetchDynamicTaxColumns();

      // 2. Now fetch the main report data
      const wardNo = new URLSearchParams(window.location.search).get("wardNo") || 1;
      // fallback removed to prevent overriding the Marathi year; if needed, set only when empty
      const yrFallback = document.querySelector('.yearRange');
      if (yrFallback && !yrFallback.textContent.trim()) {
        const y = new Date().getFullYear();
        yrFallback.textContent = `‡§µ‡§∞‡•ç‡§∑ ${y-1}-${String((y)%100).padStart(2,'0')} ‡§§‡•á ${y+2}-${String((y+3)%100).padStart(2,'0')}`;
      }

      try {
        const res = await fetch(`/3g/secondaryBatchAssessmentReport?wardNo=${wardNo}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();

        if (!data || data.length === 0) {
          document.querySelector("#reportContainer").innerHTML =
            `<p style="text-align:center;">No records found for ward ${wardNo}</p>`;
          return;
        }

        // 3. Render report only after configs and data are ready

        console.log(data[0].propertyDetails );
        console.log(data[0].propertySummary );
        console.log(data[0].propertyUnitDetails );
        console.log(data[0].unitDetails );
        renderAssessmentChunks(data);

      } catch (err) {
        console.error("‚ùå Error fetching report:", err);
        document.querySelector("#reportContainer").innerHTML =
          `<p style="text-align:center;">Error loading report: ${err.message}</p>`;
      }
    });


function formatYearRange(date) {
  const year = parseInt(date.split('-')[0]);
  const endYear = year + 3;

  const startYearNext = year + 1;
  const endYearNext = endYear + 1;

  // Convert all four digits for start and end years
  const startDev = convertToDevanagari(year.toString());
  const startNextDev = convertToDevanagari(startYearNext.toString().slice(-2)); // keep last 2 digits for look
  const endDev = convertToDevanagari(endYear.toString());
  const endNextDev = convertToDevanagari(endYearNext.toString().slice(-2));

  return `‡§∏‡§® ${startDev}-${startNextDev} ‡§§‡•á ${endDev}-${endNextDev}`;
}

function convertToDevanagari(numStr) {
  const digits = ['‡•¶','‡•ß','‡•®','‡•©','‡•™','‡•´','‡•¨','‡•≠','‡•Æ','‡•Ø'];
  return numStr.replace(/[0-9]/g, d => digits[d]);
}


    // üîπ Fetch council details and fill header
    function fetchCouncilDetails() {
  fetch('/3g/getCouncilDetails')
    .then(res => res.json())
    .then(data => {
      if (data && data.length > 0) {
        const c = data[0];
        window.__councilDetails = c;

        document.querySelector('.councilName').textContent =
          `${c.localName || '‡§®‡§ó‡§∞ ‡§™‡§∞‡§ø‡§∑‡§¶'} / ${c.standardName || 'Nagar Parishad'}`;

        // Left logo always present
        if (c.imageBase64 && c.imageBase64.trim() !== '') {
          document.querySelector('.councilLogoLeft').src = 'data:image/png;base64,' + c.imageBase64;
        }

        // Right logo optional
        const rightLogo = document.querySelector('.councilLogoRight');
        if (c.image2Base64 && c.image2Base64.trim() !== '') {
          rightLogo.src = 'data:image/png;base64,' + c.image2Base64;
          rightLogo.style.display = 'block';
        } else {
          rightLogo.style.display = 'none';
        }

         // ‚úÖ FIX: Assign local & standard site/district variables properly
        const localSite = c.localSiteNameVC || '';
        const stdSite = c.standardSiteNameVC || '';
        const localDistrict = c.localDistrictNameVC || '';
        const stdDistrict = c.standardDistrictNameVC || '';

        // ‚úÖ Update the placeholders on page
        const siteSpan = document.querySelector('.siteName');
        const distSpan = document.querySelector('.districtName');
        if (siteSpan) siteSpan.textContent = localSite || stdSite;
        if (distSpan) distSpan.textContent = localDistrict || stdDistrict;
      }
    })
    .catch(err => console.error('‚ùå Failed to fetch council details:', err));
}


    /* --------------------------------------
    üîπ Render chunks (3 reports per page)
       -------------------------------------- */
    function renderAssessmentChunks(data) {

      // 1Ô∏è‚É£ Sort the complete dataset by FINAL property number (e.g. 010001, 010002, etc.)
      data.sort((a, b) => {
        const valA = a.propertyDetails?.pdFinalpropnoVc || '';
        const valB = b.propertyDetails?.pdFinalpropnoVc || '';
        return valA.localeCompare(valB, undefined, { numeric: true });
      });

      // 2Ô∏è‚É£ Group the sorted data by NEW property number (unit-level grouping)
      const grouped = data.reduce((acc, prop) => {
        const key = prop.propertyDetails?.pdNewpropertynoVc; // group units of same property together
        if (!key) return acc; // skip invalid records
        if (!acc[key]) acc[key] = [];
        acc[key].push(prop);
        return acc;
      }, {});

      // (the rest of your existing rendering logic stays the same below)
      const reportContainer = document.querySelector("#reportContainer");
      reportContainer.innerHTML = "";
      const groups = Object.values(grouped);

      // --- DYNAMIC HEADER GENERATION ---
      const taxConfigs = window.dynamicTaxConfigs || [];
      // +1 for '‡§è‡§ï‡•Ç‡§£' (Total) column
      const taxColSpan = taxConfigs.length + 2;

      // Helper to generate dynamic tax headers
      const createTaxHeaders = (className) => {
        return taxConfigs.map(c => {
          // Use vertical class 'v' if name is long
          const vClass = c.localNameVc.length > 5 ? 'v' : '';
          return `<th class="${className} ${vClass}">${c.localNameVc}</th>`;
        }).join('');
      };

      const p1TaxHeaders = createTaxHeaders('p1');
      const p2HearingHeaders = createTaxHeaders('p2');
      const p2AppealHeaders = createTaxHeaders('p2');

      // Header HTML to clone each time
      const councilHeaderHTML = document.querySelector("#mainHeader").outerHTML;

      const tableHeadHTML = `
        <thead>
          <tr>
            <th class="p1" rowspan="3" >‡§ï‡•ç‡§∞.</th>
            <th class="p1 " rowspan="3">‡§∞‡§∏‡•ç‡§§‡§æ,<br>‡§µ‡§ø‡§≠‡§æ‡§ó,<br>‡§Æ‡§Ç‡§°‡§≥‡§æ‡§ö‡•á ‡§®‡§æ‡§µ ‡§µ ‡§µ‡§æ‡§° ‡§ï‡•ç‡§∞.</th>
            <th class="p1 " rowspan="3">‡§ù‡•ã‡§® ‡§ï‡•ç‡§∞.<br>(‡§®‡§µ‡•Ä‡§® / ‡§ú‡•Å‡§®‡§æ)</th>
            <th class="p1 " rowspan="3">‡§Æ‡§æ‡§≤‡§Æ‡§§‡•ç‡§§‡§æ ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï<br>(‡§®‡§µ‡•Ä‡§® / ‡§ú‡•Å‡§®‡§æ / ‡§∏‡§π. ‡§Æ‡§æ. ‡§®‡§Ç.)</th>
            <th class="p1 group" colspan="3">‡§Æ‡§æ‡§≤‡§Æ‡§§‡•ç‡§§‡•á‡§ö‡•á ‡§µ‡§∞‡•ç‡§£‡§®</th>
            <th class="p1 " rowspan="3">‡§Æ‡§æ‡§≤‡§ï‡§æ‡§ö‡•á ‡§®‡§æ‡§µ</th>
            <th class="p1" rowspan="3">‡§≠‡•ã‡§ó‡§µ‡§ü‡§æ‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§®‡§æ‡§µ</th>
            <th class="p1 v" rowspan="3">‡§Æ‡§æ‡§≤‡§Æ‡§§‡•ç‡§§‡•á‡§ö‡•á ‡§Ö‡§Ç‡§¶‡§æ‡§ú‡§ø‡§§ ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§≠‡§æ‡§°‡•á ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th>
            <th class="p1 v" rowspan="3">‡§≠‡§æ‡§°‡•ç‡§Ø‡§æ‡§®‡•á ‡§¶‡§ø‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§≠‡§æ‡§ó‡§æ‡§ö‡•á ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§≠‡§æ‡§°‡•á</th>
            <th class="p1 v" rowspan="3">‡§≠‡§æ‡§°‡•ç‡§Ø‡§æ‡§®‡•á ‡§® ‡§¶‡§ø‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§≠‡§æ‡§ó‡§æ‡§ö‡•á ‡§Ö‡§Ç‡§¶‡§æ‡§ú‡§ø‡§§ ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§≠‡§æ‡§°‡•á</th>
            <th class="p1 v" rowspan="3">‡§á‡§Æ‡§æ‡§∞‡§§‡•Ä‡§ö‡•á ‡§µ‡§æ ‡§ú‡§Æ‡§ø‡§®‡•Ä‡§ö‡•á ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§≠‡§æ‡§°‡•á</th>
            <th class="p1 v" rowspan="3">‡§¶‡•Å‡§∞‡•Å‡§∏‡•ç‡§§‡•Ä ‡§á‡§§‡•ç‡§Ø‡§æ‡§¶‡•Ä ‡§∏‡§æ‡§†‡•Ä 10% ‡§µ‡§ú‡§æ‡§µ‡§ü</th>
            <th class="p1 v" rowspan="3">‡§á‡§Æ‡§æ‡§∞‡§§‡•Ä‡§ö‡•á ‡§µ‡§æ ‡§ú‡§Æ‡§ø‡§®‡•Ä‡§ö‡•á ‡§ï‡§∞‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th>
            <th class="p1 group" colspan="${taxColSpan}">‡§Ü‡§ï‡§æ‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ü‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§ï‡§∞‡§æ‡§Ç‡§ö‡•Ä ‡§∞‡§ï‡•ç‡§ï‡§Æ (‡§∏‡•Å‡§®‡§æ‡§µ‡§£‡•Ä ‡§Ü‡§ß‡•Ä‡§ö‡•á)</th>
            <th class="seam" rowspan="3"></th>
            <th class="p2" rowspan="3">Sr. No.</th>
            <th class="p2 group" colspan="${taxColSpan}">‡§Ü‡§ï‡§æ‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ø‡•á‡§£‡§æ‡§±‡•ç‡§Ø‡§æ ‡§ï‡§∞‡§æ‡§Ç‡§ö‡•Ä ‡§∞‡§ï‡•ç‡§ï‡§Æ (‡§Ü‡§ï‡•ç‡§∑‡•á‡§™ / ‡§∏‡•Å‡§®‡§æ‡§µ‡§£‡•Ä ‡§®‡§Ç‡§§‡§∞‡§ö‡•á)</th>
            <th class="p2" rowspan="3">‡§Ü‡§ï‡•ç‡§∑‡•á‡§™‡§æ‡§¨‡§æ‡§¨‡§§</th>
            <th class="p2" rowspan="3">‡§∏‡•Å‡§®‡§æ‡§µ‡§£‡•Ä ‡§®‡§ø‡§ï‡§æ‡§≤</th>
            <th class="p2 group" colspan="${taxColSpan}">‡§Ü‡§ï‡§æ‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ü‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§ï‡§∞‡§æ‡§Ç‡§ö‡•ç‡§Ø‡§æ ‡§∞‡§ï‡§Æ (‡§Ö‡§™‡•Ä‡§≤ ‡§®‡§Ç‡§§‡§∞)</th>
            <th class="p2" rowspan="3">‡§Ö‡§ß‡§ø‡§ï‡•É‡§§ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§£ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä‡§ö‡•Ä ‡§∏‡§π‡•Ä</th>
            <th class="p2" rowspan="3">‡§Ö‡§™‡•Ä‡§≤ ‡§∏‡§Æ‡§ø‡§§‡•Ä ‡§∏‡§≠‡§æ‡§™‡§§‡•Ä‡§ö‡•Ä ‡§∏‡§π‡•Ä</th>
            <th class="p2" rowspan="3">‡§´‡•á‡§∞‡§´‡§æ‡§∞ ‡§¨‡§Å‡§≤‡§ö‡§æ ‡§∂‡•á‡§∞‡§æ ‡§µ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§π‡•Ä</th>
            <th class="p2 v" rowspan="3">‡§µ‡§æ‡§™‡§∞ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ / ‡§Æ‡§ú‡§≤‡§æ / ‡§Æ‡§æ‡§≤‡§ï, ‡§≠‡§æ‡§°‡•á‡§ï‡§∞‡•Ç</th>
          </tr>
          <tr>
            <th class="p1 v">‡§µ‡§æ‡§™‡§∞ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ / ‡§Æ‡§ú‡§≤‡§æ / ‡§Æ‡§æ‡§≤‡§ï / ‡§≠‡§æ‡§°‡•á‡§ï‡§∞‡•Ç</th>
            <th class="p1 v">‡§¨‡§æ‡§Ç‡§ß‡§ï‡§æ‡§Æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ / ‡§ï‡§∞‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≥</th>
            <th class="p1 v">‡§è‡§ï‡•Ç‡§£ ‡§ï‡§∞‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≥</th>


            <!-- P1: Dynamic Tax Headers -->
            <th class="p1 ">‡§ï‡§∞‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th>
            ${p1TaxHeaders}
            <th class="p1">‡§è‡§ï‡•Ç‡§£</th>

            <!-- P2 Hearing: Dynamic Tax Headers -->
            <th class="p2 ">‡§ï‡§∞‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th>
            ${p2HearingHeaders}
            <th class="p2">‡§è‡§ï‡•Ç‡§£</th>

            <!-- P2 Appeal: Dynamic Tax Headers -->
            <th class="p2 ">‡§ï‡§∞‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th>
            ${p2AppealHeaders}
            <th class="p2">‡§è‡§ï‡•Ç‡§£</th>
          </tr>
        </thead>
      `;
      // expose for the final summary page
      window.__SBAR_tableHeadHTML = tableHeadHTML;

      // --- DYNAMIC COLUMN NUMBERS ---
      // MODIFIED: Generate empty <th> tags with correct classes. CSS counters will add numbers.
      let colNum = 1;
      const staticCols1 = Array(15).fill(0).map(() => `<th class="p1"></th>`).join('');
      const p1TaxCols = Array(taxColSpan).fill(0).map(() => `<th class="p1"></th>`).join('');
      const seamCol = '<th class="seam"></th>'; // MODIFIED: Added seam class
      const p2HearingCols = Array(taxColSpan).fill(0).map(() => `<th class=\"p2\"></th>`).join('');
      const p2AppealCols = Array(taxColSpan).fill(0).map(() => `<th class=\"p2\"></th>`).join('');
      const p2SerialCol = '<th class=\"p2 p2-serial\"></th>';
      const staticCols2 = Array(6).fill(0).map(() => `<th class=\"p2\"></th>`).join('');

      // üîπ MODIFIED: Calculate P1 column count and set P2 counter to start from there.
      const p1ColCount = 15 + taxColSpan;
      const columnNumbersHTML = `<tr class=\"column-numbers\" style=\"counter-reset: counterP1 0 counterP2 ${p1ColCount};\">${staticCols1}${p1TaxCols}${seamCol}${p2SerialCol}${p2HearingCols}${p2AppealCols}${staticCols2}</tr>`;
      // Expose column index row so totals page can reuse it
      window.__SBAR_columnNumbersHTML = columnNumbersHTML;
      // --- END DYNAMIC HEADERS ---


      let chunkIndex = 0;
      for (let i = 0; i < groups.length; i += 3) {
        chunkIndex++;
        const chunk = groups.slice(i, i + 3);
        const wrapper = document.createElement("div");

        // only add council header from 2nd chunk onwards
        wrapper.innerHTML = `
          ${chunkIndex === 1 ? "" : councilHeaderHTML}
          <div class="reportWrapper">
            <table class="reportTable">${tableHeadHTML}${columnNumbersHTML}<tbody></tbody></table>
          </div>
        `;

        const tbody = wrapper.querySelector("tbody");

        chunk.forEach((group, idx) => {
          const property = group[0];
          const pd = property.propertyDetails || {};
          const psd =property.propertySummary || {};
          const usages = (group.flatMap(p => p.propertyUnitDetails || [])).map(u => (window.unitUsageLocal.get(Number(u.usageTypeVc)) || u.usageTypeVc || "")).join("<br>");
          // Derived values for mixed columns (unit-wise only)
          const units = group.flatMap(p => p.propertyUnitDetails || []);
          const unitLines = (units && units.length > 0)
            ? units.map(u => {
                const usage = (window.unitUsageLocal.get(Number(u.usageTypeVc)) || u.usageTypeVc || '-');
                const floor = (u.floorNoVc || '‚Äî');
                const occName = window.occupancyLocal.get(Number(u.occupantStatusI)) || '';
                let occDisplay = occName || '-';
                if (/tenant/i.test(occName) || /‡§≠‡§æ‡§°‡•á‡§ï‡§∞‡•Ç/.test(occName)) {
                  if (u.tenantNameVc && u.tenantNameVc.trim() !== '') {
                    occDisplay = `${occName}: ${u.tenantNameVc}`;
                  }
                }
                return `
                      ${usage}
                      <div style="border-top: 1px solid rgba(0,0,0,0.6); width: 50%; margin: 1px auto;"></div>
                      ${abbreviateFloor(u.floorNoVc)}
                      <div style="border-top: 1px solid rgba(0,0,0,0.6); width: 50%; margin: 1px auto;"></div>
                      ${occDisplay}
                    `;
                })
            : ['‚Äî / ‚Äî / ‚Äî'];
          const multiLineInfo = unitLines.join('<br>');
          const constructionBlocks = units.map(u => {
            const ctype = (u.constructionTypeVc || '‚Äî');
            const tArea = (u.taxableAreaFl != null && u.taxableAreaFl !== '') ? u.taxableAreaFl : '‚Äî';
            return `<div class=\"description-block\">${ctype} <div style="border-top: 1px solid rgba(0,0,0,0.3); width: 60%; margin: 3px auto;"></div> ${tArea}</div>`;
          }).join('');
          const totalTaxableArea = (psd.totalAssessmentAreaFl != null)
            ? psd.totalAssessmentAreaFl
            : units.reduce((s, u) => s + (parseFloat(u.taxableAreaFl) || 0), 0);
          const beforeAll = group.map(p => p.taxKeyValueMapAfterAssess || {});
          const afterAll = group.map(p => p.taxKeyValueMapAfterHearing || {});

          const mergeTaxMaps = (arr) => {
            const total = {};
            arr.forEach(m => {
              for (const [k, v] of Object.entries(m)) {
                total[k] = (total[k] || 0) + (parseFloat(v) || 0);
              }
            });
            return total;
          };

          const before = mergeTaxMaps(beforeAll);
          const after = mergeTaxMaps(afterAll);

          // Calculate totals dynamically
          const totalBefore = taxConfigs.reduce((sum, tax) => sum + (before[tax.taxKeyL] || 0), 0);
          const totalAfter = taxConfigs.reduce((sum, tax) => sum + (after[tax.taxKeyL] || 0), 0);
          const afterTaxable = (after["taxablevalue"] || after["ratablevalue"] || psd?.afterFinalRvFl || psd?.afterFinalRvFl || 0);

          // --- DYNAMIC DATA ROW GENERATION ---
          const p1TaxData = `
            <td class="p1">${psd?.beforeFinalRvFl || 0}</td>
            ${taxConfigs.map(c => `<td class=\"p1\">${before[c.taxKeyL] || 0}</td>`).join('')}
          `;

          const p2HearingData = taxConfigs.map(c =>
            `<td class=\"p2\">${after[c.taxKeyL] || 0}</td>`
          ).join('');

          // Appeal taxes are empty in the original logic, so we just generate empty cells
          const p2AppealData = taxConfigs.map(() => `<td class="p2"></td>`).join('');
          // --- END DYNAMIC DATA ---


          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="p1">${i + idx + 1}</td>
            <td class="p1">${pd.pdWardI || ""}</td>
            <td class="p1">${pd.pdZoneI || ""}</td>
            <td class="p1 property-no">
              ${
                [pd.pdFinalpropnoVc, pd.pdOldpropnoVc, pd.pdSurypropnoVc]
                  .map(v => `<div class="prop-line">${v || ''}</div>`)
                  .join('')
              }
            </td>

            <td class="p1 multi-line">
                  ${[
                    property.propertyTypeVc || "‚Äî", "<br>" ,
                    property.usageTypeVc || "‚Äî","<br>",
                    property.floorNoVc || "‚Äî","<br>",
                    property.ownerTypeVc || "‚Äî"
                  ].filter(v => v && v.trim() !== "").join("<br>")}
            </td>
            <td class="p1"></td>
            <td class="p1"></td>
            <td class="p1">${pd.pdOwnernameVc ? '‡§∂‡•ç‡§∞‡•Ä/‡§∂‡•ç‡§∞‡•Ä‡§Æ‡§§‡•Ä. ' + pd.pdOwnernameVc : '‚Äî'}</td>
            <td class="p1">${pd.pdOccupinameF ? '‡§∂‡•ç‡§∞‡•Ä/‡§∂‡•ç‡§∞‡•Ä‡§Æ‡§§‡•Ä. ' + pd.pdOccupinameF : '‚Äî'}</td>


            <td class="p1">${psd.totalAlvFl || ""}</td>
            <td class="p1">${psd.totalYearlyRentFl || ""}</td>
            <td class="p1">${psd.consideredRvFl|| ""}</td>
            <td class="p1">${psd.totalCombinedAlvRentFl || ""}</td>
            <td class="p1">${psd.totalDepreciationAmountFl || ""}</td>
            <td class="p1">${psd.totalRatableValueFl|| ""}</td>

            <!-- P1: Dynamic Tax Data -->
            ${p1TaxData}
            <td class="p1"><b>${totalBefore.toFixed(0)}</b></td>

            <td class="seam"></td>
            <td class="p2">${i + idx + 1}</td>

            <!-- P2 Hearing: Dynamic Tax Data -->
            <td class="p2">${afterTaxable}</td>
            ${p2HearingData}
            <td class="p2"><b>${totalAfter.toFixed(0)}</b></td>
            <td class="p2">${getHearingColumn1(property.hearingStatus)}</td>
            <td class="p2">${getHearingColumn2(property.hearingStatus)}</td>


            <!-- P2 Appeal: Dynamic (empty) Tax Data -->
            <td class="p2"></td>
            ${p2AppealData}
            <td class="p2"></td> <!-- Appeal Total (empty) -->

            <!-- Static P2 Columns (Fixed Bug) -->

            <td class="p2"></td> <!-- ‡§Ö‡§ß‡§ø‡§ï‡•É‡§§ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§£ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä‡§ö‡•Ä ‡§∏‡§π‡•Ä -->
            <td class="p2"></td> <!-- ‡§Ö‡§™‡•Ä‡§≤ ‡§∏‡§Æ‡§ø‡§§‡•Ä ‡§∏‡§≠‡§æ‡§™‡§§‡•Ä‡§ö‡•Ä ‡§∏‡§π‡•Ä -->
            <td class="p2"></td> <!-- ‡§´‡•á‡§∞‡§´‡§æ‡§∞ ‡§¨‡§Å‡§≤‡§ö‡§æ ‡§∂‡•á‡§∞‡§æ ‡§µ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§π‡•Ä -->
            <td class="p2">${multiLineInfo}</td> <!-- ‡§µ‡§æ‡§™‡§∞ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ -->
          `;
          // Fill mixed info cells for Part 1: [4]=Usage/Floor/Owner/Tenant, [5]=Construction/Taxable, [6]=Total Taxable
            try {
              const p1Cells = tr.querySelectorAll('td.p1');
              if (p1Cells.length > 7) {
                p1Cells[4].classList.add('description-cell');
                p1Cells[4].classList.add('usage-cell');
                p1Cells[4].innerHTML = multiLineInfo
                  .split('<br>')
                  .map(s => `<div class="description-block">${s}</div>`)
                  .join('');
                p1Cells[5].classList.add('description-cell');
                p1Cells[5].innerHTML = constructionBlocks;
                p1Cells[6].textContent = (totalTaxableArea ?? '').toString();
              }

              // Mirror partitioning for the last P2 column (‡§µ‡§æ‡§™‡§∞ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ / ‡§Æ‡§ú‡§≤‡§æ / ‡§Æ‡§æ‡§≤‡§ï, ‡§≠‡§æ‡§°‡•á‡§ï‡§∞‡•Ç)
              const p2Cells = tr.querySelectorAll('td.p2');
              if (p2Cells.length > 0) {
                const lastP2 = p2Cells[p2Cells.length - 1];
                lastP2.classList.add('description-cell');
                lastP2.classList.add('usage-cell');
                lastP2.innerHTML = multiLineInfo
                  .split('<br>')
                  .map(s => `<div class="description-block">${s}</div>`)
                  .join('');
              }
            } catch (e) { console.warn('Row mixin fill failed', e); }
          tbody.appendChild(tr);

        // Add placeholder rows (assuming 3 rows per property)
          // ‚úÖ Partition row (visually separates properties)
            const partitionRow = document.createElement("tr");
            partitionRow.classList.add("partition-row");

            // Create same structure as a normal data row (so alignment is perfect)
            let partitionCells = "";

            // Part 1 cells
            for (let x = 0; x < 15 + taxColSpan; x++) {
              partitionCells += `<td class="p1"></td>`;
            }

            // Seam divider
            partitionCells += `<td class="seam"></td>`;

            // Part 2 cells
            for (let y = 0; y < taxColSpan + taxColSpan + 7; y++) {
              partitionCells += `<td class="p2"></td>`;
            }

            // Fill row
            partitionRow.innerHTML = partitionCells;
           tbody.appendChild(partitionRow.cloneNode(true));
           tbody.appendChild(partitionRow);

        });

        if (chunkIndex < groups.length) {
              wrapper.style.pageBreakAfter = "always";
          }
           reportContainer.appendChild(wrapper);
        }

        // After rendering all chunks, append a grand summary + signatures page
        try { appendTotalsAndSignaturePage(data); } catch(e) { console.warn('Totals page failed', e); }
      }

    /* print logic */
    function printPart(part) {
  document.body.classList.remove('print1', 'print2');
  document.body.classList.add(part === 1 ? 'print1' : 'print2');

  // üïí Wait for layout to complete before printing
  setTimeout(() => {
    console.log("üñ®Ô∏è Printing report...");
    window.print();

    // Remove print class after printing
    setTimeout(() => document.body.classList.remove('print1', 'print2'), 500);
  }, 800); // ‚è≥ small delay to let DOM paint fully
}

// === Grand totals + signature page ===
function appendTotalsAndSignaturePage(data) {
  const container = document.querySelector('#reportContainer');
  const taxConfigs = window.dynamicTaxConfigs || [];
  // Reuse the same council header markup used on other pages
  const headerHTML = (document.querySelector('#mainHeader')?.outerHTML) || '';
  // Use the full table head plus the column index row on totals page
  const dynamicHead = (window.__SBAR_tableHeadHTML || '') + (window.__SBAR_columnNumbersHTML || '');
  const taxColSpan = (taxConfigs.length + 2);
  const p1ColCount = 15 + taxColSpan; // matches main table logic (15 fixed + p1 tax block)
  const p2ColCount = (taxColSpan + taxColSpan + 6) + 1; // Sr.No + hearing block + appeal block + 6 trailing (align header)
  const totalCols = p1ColCount + 1 + p2ColCount; // P1 + seam + P2

  // Totals computation
  const toNum = (v) => {
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  };

  const totals = {};
  taxConfigs.forEach(t => totals[t.taxKeyL] = 0);
  // Grand totals for BEFORE (assessment) dynamic taxes
  const beforeTotals = {};
  taxConfigs.forEach(t => beforeTotals[t.taxKeyL] = 0);

  // Group by property to avoid double counting
  const grouped = (data || []).reduce((acc, prop) => {
    const key = prop?.propertyDetails?.pdNewpropertynoVc;
    if (!key) return acc;
    (acc[key] ||= []).push(prop);
    return acc;
  }, {});

  let totalBeforeRV = 0, totalAfterRV = 0;
  let totTaxableArea = 0, totAlv = 0, totYearlyRent = 0, totConsideredRv = 0,
      totCombinedAlv = 0, totDepreciation = 0, totRatableValue = 0;

  Object.values(grouped).forEach(group => {
    const g0 = group[0] || {};
    const psd = g0.propertySummary || {};
    const after = (g0.taxKeyValueMapAfterHearing || {});

    totalBeforeRV += toNum(psd.beforeFinalRvFl);
    totalAfterRV  += toNum(psd.afterFinalRvFl);

    totTaxableArea   += toNum(psd.totalAssessmentAreaFl);
    totAlv           += toNum(psd.totalAlvFl);
    totYearlyRent    += toNum(psd.totalYearlyRentFl);
    totConsideredRv  += toNum(psd.consideredRvFl);
    totCombinedAlv   += toNum(psd.totalCombinedAlvRentFl);
    totDepreciation  += toNum(psd.totalDepreciationAmountFl);
    totRatableValue  += toNum(psd.totalRatableValueFl);

    taxConfigs.forEach(t => {
      // Sum after-hearing taxes by picking first map (they were merged per property earlier)
      totals[t.taxKeyL] += toNum(after[t.taxKeyL]);
    });

    // Sum BEFORE (assessment) dynamic taxes using the first group's map
    const before = (g0.taxKeyValueMapAfterAssess || {});
    taxConfigs.forEach(t => {
      beforeTotals[t.taxKeyL] += toNum(before[t.taxKeyL]);
    });
  });

  const totalTaxCells = taxConfigs.map(t => `
    <td class="p2"><b>${totals[t.taxKeyL].toFixed(2)}</b></td>
  `).join('');

  const totalBeforeTaxSum = taxConfigs.reduce((sum, t) => sum + toNum(beforeTotals[t.taxKeyL]), 0);
  const totalAfterTaxSum  = taxConfigs.reduce((sum, t) => sum + toNum(totals[t.taxKeyL]), 0);
  const wrap = document.createElement('div');
  wrap.style.pageBreakBefore = 'always';
  wrap.innerHTML = `
    ${headerHTML}
    <div class="reportWrapper">
      <table class="reportTable" style="width:100%; border-collapse:collapse; margin-bottom:6px;">
        ${dynamicHead}
        <tbody>
          <tr class="total-row">
            <!-- P1 fixed cells (15) with totals in their rightful columns -->
            <td class="p1" colspan="6" style="text-align:center; font-weight:bold;"></td>
            <td class="p1"><b>${totTaxableArea.toFixed(2)}</b></td>
            <td class="p1" colspan="2" style="text-align:center; font-weight:bold;">‡§è‡§ï‡•Ç‡§£</td>
            <td class="p1"><b>${totAlv.toFixed(2)}</b></td>
            <td class="p1"><b>${totYearlyRent.toFixed(2)}</b></td>
            <td class="p1"><b>${totConsideredRv.toFixed(2)}</b></td>
            <td class="p1"><b>${totCombinedAlv.toFixed(2)}</b></td>
            <td class="p1"><b>${totDepreciation.toFixed(2)}</b></td>
            <td class="p1"><b>${totRatableValue.toFixed(2)}</b></td>
            <!-- P1 tax block: BEFORE RV total + dynamic BEFORE tax totals + BEFORE taxes grand total -->
            <td class="p1"><b>${totalBeforeRV.toFixed(2)}</b></td>
            ${taxConfigs.map(t => `<td class=\"p1\"><b>${(beforeTotals[t.taxKeyL]||0).toFixed(2)}</b></td>`).join('')}
            <td class="p1"><b>${totalBeforeTaxSum.toFixed(2)}</b></td>
            <!-- Seam divider -->
            <td class="seam"></td>
            <!-- P2: Sr.No. (empty on totals row) -->
            <td class="p2"></td>
            <!-- P2: hearing dynamic taxes (After RV + taxes + After Taxes total) -->
            <td class="p2"><b>${totalAfterRV.toFixed(2)}</b></td>
            ${taxConfigs.map(t => `<td class=\"p2\"><b>${(totals[t.taxKeyL]||0).toFixed(2)}</b></td>`).join('')}
            <td class="p2"><b>${totalAfterTaxSum.toFixed(2)}</b></td>
            <!-- P2: appeal block (empty) -->
            ${Array(taxColSpan).fill('<td class="p2"></td>').join('')}
            <!-- P2: 6 trailing columns (empty) to match header -->
            ${Array(6).fill('<td class="p2"></td>').join('')}
          </tr>
        </tbody>
      </table>
    </div>

  

    <div style="margin-top:40px;">
      <table style="width:100%; border:none; text-align:center; font-size:16px;">
        <tr>
          <td style="width:33%;"><br>_________________________<br><b>‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä</b><br>(Chief Officer)</td>
          <td style="width:33%;"><br>_________________________<br><b>‡§ï‡§∞ ‡§Ö‡§ß‡•Ä‡§ï‡•ç‡§∑‡§ï</b><br>(Tax Superintendent)</td>
          <td style="width:33%;"><br>_________________________<br><b>‡§ï‡§∞ ‡§®‡§ø‡§∞‡•Ä‡§ï‡•ç‡§∑‡§ï</b><br>(Tax Inspector)</td>
        </tr>
      </table>
    </div>
  `;

  container.appendChild(wrap);

  // Replace legacy summary/signature blocks with P1/P2 split layout
  try {
    // Remove the two old blocks (summary note and 3-column signatures)
    const oldSummary = wrap.querySelector('div[style*="margin-top:30px"][style*="font-size:15px"]');
    if (oldSummary) oldSummary.remove();
    const oldSigTableWrap = Array.from(wrap.querySelectorAll('div[style*="margin-top:40px"]'))
      .find(d => d.querySelector('table'));
    if (oldSigTableWrap) oldSigTableWrap.remove();

    // Build new P1/P2 table aligned to seam columns
    const postWrap = document.createElement('div');
    postWrap.className = 'reportWrapper no-outline';
    postWrap.innerHTML = `
      <table class="reportTable no-grid" style="width:100%; border-collapse:collapse; margin-top:8px; border:none;">
        <tbody>
          <tr>
            <td class="p1" colspan="${p1ColCount}">
              <div style="display:flex; justify-content:space-between; gap:20px;">
                <div style="text-align:center;">
                  <br>
                  <br>
                  <br>
                  <p>‡§ï‡§∞‡§Ö‡§ß‡§ø‡§ï‡•ç‡§∑‡§ï / ‡§®‡§ø‡§∞‡•Ä‡§ï‡•ç‡§∑‡§ï</p>
                </div>
                <div style="text-align:center;">
                  <br>
                  <br>
                  <br>
                  <p>‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä</p>
                </div>
              </div>
            </td>
            <td class="seam"></td>
            <td class="p2" colspan="${p2ColCount}">
  <div class="p2-flex-row">
    <div class="p2-bullets">
      <p>‡§µ‡§∞‡•ç‡§∑ ‡•®‡•¶‡•®‡•©-‡•®‡•™ ‡§§‡•á ‡•®‡•¶‡•®‡•¨-‡•®‡•≠ ‡§Ø‡§æ ‡§¶‡§∞‡§Æ‡•ç‡§Ø‡§æ‡§® ‡§Ü‡§ï‡§æ‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ü‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§ï‡§∞‡§æ‡§Ç‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§µ‡§æ‡§¢ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§ò‡§ü ‡§ñ‡§æ‡§≤‡•Ä‡§≤‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•á ‡§Ü‡§π‡•á:</p>
      <ul>
  <li>
    Increase or decrease during the year 2023-2024 as per Increase and Decrease Register /
    ‡§ò‡§ü-‡§µ‡§æ‡§¢ ‡§®‡•ã‡§Ç‡§¶‡§µ‡§π‡•Ä ‡§®‡•Å‡§∏‡§æ‡§∞ ‡•®‡•¶‡•®‡•©-‡•®‡•¶‡•®‡•™ ‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§§ ‡§ù‡§æ‡§≤‡•á‡§≤‡•Ä ‡§ò‡§ü ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§µ‡§æ‡§¢ ‡§∞‡•Å. ____________
  </li>
  <li>
    Increase or decrease during the year 2024-2025 as per Increase and Decrease Register /
    ‡§ò‡§ü-‡§µ‡§æ‡§¢ ‡§®‡•ã‡§Ç‡§¶‡§µ‡§π‡•Ä ‡§®‡•Å‡§∏‡§æ‡§∞ ‡•®‡•¶‡•®‡•™-‡•®‡•¶‡•®‡•´ ‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§§ ‡§ù‡§æ‡§≤‡•á‡§≤‡•Ä ‡§ò‡§ü ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§µ‡§æ‡§¢ ‡§∞‡•Å. ____________
  </li>
  <li>
    Increase or decrease during the year 2025-2026 as per Increase and Decrease Register /
    ‡§ò‡§ü-‡§µ‡§æ‡§¢ ‡§®‡•ã‡§Ç‡§¶‡§µ‡§π‡•Ä ‡§®‡•Å‡§∏‡§æ‡§∞ ‡•®‡•¶‡•®‡•´-‡•®‡•¶‡•®‡•¨ ‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§§ ‡§ù‡§æ‡§≤‡•á‡§≤‡•Ä ‡§ò‡§ü ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§µ‡§æ‡§¢ ‡§∞‡•Å. ____________
  </li>
  <li>
    Increase or decrease during the year 2026-2027 as per Increase and Decrease Register /
    ‡§ò‡§ü-‡§µ‡§æ‡§¢ ‡§®‡•ã‡§Ç‡§¶‡§µ‡§π‡•Ä ‡§®‡•Å‡§∏‡§æ‡§∞ ‡•®‡•¶‡•®‡•¨-‡•®‡•¶‡•®‡•≠ ‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§§ ‡§ù‡§æ‡§≤‡•á‡§≤‡•Ä ‡§ò‡§ü ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§µ‡§æ‡§¢ ‡§∞‡•Å. ____________
  </li>
</ul>

    </div>
    <div class="p2-sign"><br><br><br><br><br><br><br><br>
      <p><b>‡§™‡•ç‡§∞‡§æ‡§ß‡§ø‡§ï‡•É‡§§ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§£ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä, ‡§®.‡§™. <span class="siteName"></span></b></p>
      <p class="tatha">‡§§‡§•‡§æ</p>
      <p><b>‡§®‡§ó‡§∞ ‡§∞‡§ö‡§®‡§æ‡§ï‡§æ‡§∞, ‡§®‡§ó‡§∞ ‡§∞‡§ö‡§®‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø, <span class="districtName"></span></b></p>
    </div>

  </div>
</td>
          </tr>
        </tbody>
      </table>`;
    wrap.appendChild(postWrap);
    // Append council local name under left signature
    try {
      const nameText = (document.querySelector('.councilName')?.textContent || '');
      const local = (nameText.split('/')?.[0] || '').trim();
      if (local) {
        const leftSig = postWrap.querySelector('td.p1 > div > div');
        if (leftSig) {
          const p = document.createElement('p');
          p.textContent = local;
          p.style.margin = '2px 0';
          p.style.textAlign = 'center';
          leftSig.appendChild(p);
        }
      }
      // Populate site and district names in P2 block using stored council details
      const cdet = window.__councilDetails || {};
      const siteText = (cdet.localSiteNameVC || cdet.standardSiteNameVC || '').toString();
      const distText = (cdet.localDistrictNameVC || cdet.standardDistrictNameVC || '').toString();
      const siteSpan2 = postWrap.querySelector('.siteName');
      const distSpan2 = postWrap.querySelector('.districtName');
      if (siteSpan2 && siteText) siteSpan2.textContent = siteText;
      if (distSpan2 && distText) distSpan2.textContent = distText;
    } catch(e) { /* no-op */ }
  } catch (e) { console.warn('Post-totals layout patch failed', e); }

  // Ensure the summary table width behaves for screen but not in print
  try {
    const first = container.querySelector('.reportWrapper .reportTable');
    const last = wrap.querySelector('.reportWrapper .reportTable');
    if (first && last) {
      // If printing, clamp to 100% to avoid scrollbars
      if (window.matchMedia && window.matchMedia('print').matches) {
        last.style.minWidth = '100%';
        last.style.width = '100%';
      } else {
        const w = first.scrollWidth || first.offsetWidth;
        if (w && w > 0) {
          last.style.minWidth = w + 'px';
          last.style.width = 'max-content';
        }
      }
    }
  } catch(e) { console.warn('Totals table width sync failed', e); }

  // Safety helpers for print layout toggle
  const __clampForPrint = () => {
    try {
      document.querySelectorAll('.reportWrapper .reportTable').forEach(t => {
        t.style.minWidth = '100%';
        t.style.width = '100%';
      });
      document.querySelectorAll('.reportWrapper').forEach(w => {
        w.style.overflow = 'visible';
        w.style.maxHeight = 'none';
        w.style.border = 'none';
        w.style.boxShadow = 'none';
      });
    } catch(e) { /* no-op */ }
  };
  const __restoreAfterPrint = () => {
    try {
      // Remove inline styles so screen CSS takes effect again
      document.querySelectorAll('.reportWrapper .reportTable').forEach(t => {
        t.style.minWidth = '';
        t.style.width = '';
      });
      document.querySelectorAll('.reportWrapper').forEach(w => {
        w.style.overflow = '';
        w.style.maxHeight = '';
        w.style.border = '';
        w.style.boxShadow = '';
      });
      document.body.classList.remove('print1', 'print2');
    } catch(e) { /* no-op */ }
  };
  // Clamp before printing and restore after
  window.addEventListener('beforeprint', __clampForPrint);
  window.addEventListener('afterprint', __restoreAfterPrint);
  // Also react to media query changes (Chrome/Edge)
  try {
    const mq = window.matchMedia && window.matchMedia('print');
    if (mq && mq.addEventListener) {
      mq.addEventListener('change', e => { e.matches ? __clampForPrint() : __restoreAfterPrint(); });
    } else if (mq && mq.addListener) {
      mq.addListener(e => { e.matches ? __clampForPrint() : __restoreAfterPrint(); });
    }
  } catch(e) { /* no-op */ }
  // Extra fallbacks: when window regains focus or tab becomes visible, restore screen layout
  try {
    window.addEventListener('focus', __restoreAfterPrint);
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') __restoreAfterPrint();
    });
  } catch(e) { /* no-op */ }
}
function getHearingColumn1(status) {
  switch ((status || '').toLowerCase()) {
    case 'absent': return '‡§Ü‡§ï‡•ç‡§∑‡•á‡§™ / ‡§ó‡•à‡§∞‡§π‡§ú‡§∞';
    case 'retained': return '‡§Ü‡§ï‡•ç‡§∑‡•á‡§™ / ‡§π‡§ú‡§∞';
    case 'changed': return '‡§Ü‡§ï‡•ç‡§∑‡•á‡§™ / ‡§π‡§ú‡§∞';
    default: return '-';
  }
}

function getHearingColumn2(status) {
  switch ((status || '').toLowerCase()) {
    case 'absent': return '‡§Ü‡§ï‡§æ‡§∞‡§£‡•Ä ‡§ï‡§æ‡§Ø‡§Æ';
    case 'retained': return '‡§Ü‡§ï‡§æ‡§∞‡§£‡•Ä ‡§ï‡§æ‡§Ø‡§Æ';
    case 'changed': return '‡§¨‡§¶‡§≤';
    default: return '-';
  }
}
</script>
</body>
</html>


