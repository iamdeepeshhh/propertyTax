<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <title>Assessment Register - Combined Header</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap" rel="stylesheet">
    <style>
        table {
          border-collapse: collapse;
          width: 100%;
          border: 1px solid #000; /* full outer border */
          table-layout: fixed;
        }

        th, td {
          border: 1px solid #000; /* uniform grid lines */
          text-align: center;
          padding: 4px 3px;
          vertical-align: middle;
          line-height: 1.1;
        }

        th {
          font-weight: 600;
          background: #f9f9f9;
        }

        /* vertical headers */
        .v {
          writing-mode: vertical-rl;
          transform: rotate(180deg);
          white-space: normal;
          word-break: break-word;
          font-size: 11px;
          line-height: 1.1;
          padding: 4px 2px;
          height: 100px;
          width: 30px;
          overflow: hidden;
        }

        th.p1, td.p1,
        th.p2, td.p2 {
          background: #fff;
          border: 1px solid #000; /* reinforce edge consistency */
        }

        /* Seam column (visual divider) */
        .seam, td.seam, th.seam {
          width: 12px;
          min-width: 12px;
          background: repeating-linear-gradient(
            90deg,
            #000 0 1px,
            transparent 1px 12px
          );
          border-left: 1px solid #000;
          border-right: 1px solid #000;
          padding: 0;
        }

        body {
          font-family: 'Noto Sans Devanagari', Arial, sans-serif;
          margin: 20px;
          font-size: 13px;
        }

        .controls {
          position: sticky;
          top: 0;
          background: #fff;
          padding: 10px;
          display: flex;
          gap: 10px;
          z-index: 10;
          border-bottom: 1px solid #ccc;
        }
        button {
          background: #004aad;
          color: #fff;
          border: none;
          padding: 8px 14px;
          border-radius: 6px;
          cursor: pointer;
        }
        button.secondary { background: #0e7c3a; }

        .report-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-left: -10px;
          padding: 10px 0;
        }
        .report-header img {
          height: 90px;
          width: auto;
          margin-left: 120px;
          border-radius: 20px;
          transform: scale(1.1);
        }
        .report-header div {
          flex-grow: 1;
          text-align: center;
          padding-left: 50px;
        }
        .report-header h1, .report-header p {
          margin: 0;
          padding: 0;
          font-size: 20px;
        }
        .report-header h1 {
          color: red;
          font-size: 22px;
        }

        tr.divider-row td {
          border-top: 2px double #000;
          border-bottom: none;
          background: #fff;
          height: 6px;
          padding: 0;
        }

        .column-numbers th {
          background: rgb(136, 214, 250);
          font-size: 11px;
          font-weight: bold;
          border: 1px solid #000;
          text-align: center;
        }

        /* üîπ CSS Counters for Column Numbers */
        tr.column-numbers {
          /* 1. Reset counters. The P2 reset value will be overridden by an inline style. */
          counter-reset: counterP1 0 counterP2 0;
        }

        /* 2. Increment P1 counter for p1 columns */
        tr.column-numbers th.p1 {
          counter-increment: counterP1;
        }
        /* 2. Increment P2 counter for p2 columns */
        tr.column-numbers th.p2 {
          counter-increment: counterP2;
        }

        /* 3. Display counters using ::before */
        tr.column-numbers th.p1::before {
          content: counter(counterP1);
        }
        tr.column-numbers th.p2::before {
          content: counter(counterP2);
        }
        /* Note: .seam columns won't be incremented or display content, which is correct. */


        td.property-no {
          line-height: 1.4;
          text-align: center;
          vertical-align: middle;
          white-space: pre-line; /* allows line breaks (\n) */
          font-weight: 600;
          font-size: 12px;
          padding: 4px;
        }

        td.multi-line {
          text-align: center;
          vertical-align: middle;
          line-height: 1.3;
          white-space: pre-line; /* allows \n or <br> line breaks */
          font-size: 12px;
          font-weight: 500;
          padding: 3px;
        }

        /* üîπ Optional: light background header strip like your screenshot */
        tr.highlight-row td {
          background-color: #dff0ff;
          font-weight: bold;
          border-top: 2px solid #000;
          border-bottom: 2px solid #000;
        }

        td.description-cell {
       vertical-align: top;
       text-align: center;
       padding: 0;
       font-size: 12px;
       border-left: 1px solid #000;
       border-right: 1px solid #000;
      }

      /* üîπ Each usage/floor block inside that cell */
      .description-block {
        border-bottom: 1px solid #000;
        padding: 4px 2px;
        line-height: 1.3;
        white-space: pre-line;
      }

      .description-block:last-child {
        border-bottom: none; /* remove line on last */
      }

      /* üîπ Optional blue highlight row (like your header strip) */
      tr.highlight td {
        background-color: #d8efff;
        font-weight: bold;
      }

        /* printing */
        @media print {
          .controls { display: none !important; }
          header.report-header, thead {
            display: table-header-group;
          }
            body.print1 .p2, body.print1 .seam { display: none !important; }
            body.print2 .p1, body.print2 .seam { display: none !important; }
            tfoot { display: table-footer-group; }
            tr.page-break { page-break-after: always; }

          /* 4. Printing Logic for Counters */
          /* These rules are no longer needed, as the parent <th>
             (e.g., body.print1 .p2) is already set to display: none. */
        }

        @page { size: A3 landscape; margin: 1cm; }
    </style>
</head>
<body>
<div class="controls">
    <button onclick="printPart(1)">üñ®Ô∏è Print Part 1 (‡§∏‡•Å‡§®‡§æ‡§µ‡§£‡•Ä ‡§Ü‡§ß‡•Ä‡§ö‡•á ‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§)</button>
    <button class="secondary" onclick="printPart(2)">üñ®Ô∏è Print Part 2 (‡§∏‡•Å‡§®‡§æ‡§µ‡§£‡•Ä ‡§®‡§Ç‡§§‡§∞‡§ö‡•á ‡§µ ‡§Ö‡§™‡•Ä‡§≤ ‡§®‡§Ç‡§§‡§∞)</button>
</div>

<!-- Main Header (first appearance) -->
<header class="report-header" id="mainHeader">
    <img class="councilLogo" src="https://example.com/default-image.png" alt="Council Logo" onerror="this.src='https://placehold.co/100x100/eee/ccc?text=Logo';">
    <div>
        <h1 class="councilName">‡§®‡§ó‡§∞ ‡§™‡§Ç‡§ö‡§æ‡§Ø‡§§, sitename / Nagar Panchayat sitename</h1>
        <p>(‡§®‡§Æ‡•Å‡§®‡§æ ‡•™‡•© ‡§®‡§ø‡§Ø‡§Æ ‡•≠‡•™ ‡§™‡§π‡§æ)/(Form No. 43 See Rule No. 74)</p>
        <p><span class="yearRange"></span> ‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§Ç‡§∏‡§æ‡§†‡•Ä ‡§á‡§Æ‡§æ‡§∞‡§§‡•Ä ‡§µ ‡§ú‡§Æ‡•Ä‡§® ‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§Ü‡§ï‡§æ‡§∞‡§£‡•Ä ‡§∏‡•Ç‡§ö‡•Ä</p>
    </div>
</header>

<!-- Placeholder container for chunks -->
<div id="reportContainer"></div>

<script>
    // üîπ Global store for dynamic tax configurations
    window.dynamicTaxConfigs = [];

    // üîπ Fetch only dynamic tax column names
    async function fetchDynamicTaxColumns() {
      try {
        const res = await fetch("/3g/reportTaxConfigs?template=ASSESSMENT_REGISTER");
        if (!res.ok) throw new Error(`HTTP ${res.status} fetching tax configs`);

        const configs = await res.json();

        // Sort by sequence and store globally
        configs.sort((a, b) => a.sequenceI - b.sequenceI);
        window.dynamicTaxConfigs = configs;

        console.log("‚úÖ Dynamic tax headers loaded:", configs.map(c => c.localNameVc));
      } catch (err) {
        console.error("‚ùå Failed to fetch tax configs:", err);
        alert("Error: Could not load dynamic tax columns. Report may be incorrect.");
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // Run council details fetch in parallel
      fetchCouncilDetails();

      // 1. Wait for tax configurations to load first
      await fetchDynamicTaxColumns();

      // 2. Now fetch the main report data
      const wardNo = new URLSearchParams(window.location.search).get("wardNo") || 1;
      const yearRange = document.querySelector(".yearRange");
      const currentYear = new Date().getFullYear();
      yearRange.textContent = `${currentYear - 1}-${currentYear}`;

      try {
        const res = await fetch(`/3g/secondaryBatchAssessmentReport?wardNo=${wardNo}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();

        if (!data || data.length === 0) {
          document.querySelector("#reportContainer").innerHTML =
            `<p style="text-align:center;">No records found for ward ${wardNo}</p>`;
          return;
        }

        // 3. Render report only after configs and data are ready
        renderAssessmentChunks(data);

      } catch (err) {
        console.error("‚ùå Error fetching report:", err);
        document.querySelector("#reportContainer").innerHTML =
          `<p style="text-align:center;">Error loading report: ${err.message}</p>`;
      }
    });


    // üîπ Fetch council details and fill header
    function fetchCouncilDetails() {
      fetch('/3g/getCouncilDetails')
        .then(res => res.json())
        .then(data => {
          if (data && data.length > 0) {
            const c = data[0];
            document.querySelector('.councilName').textContent =
              `${c.localNameVc || '‡§®‡§ó‡§∞ ‡§™‡§∞‡§ø‡§∑‡§¶'} / ${c.standardName || 'Nagar Parishad'}`;
            if (c.imageBase64)
              document.querySelector('.councilLogo').src = 'data:image/png;base64,' + c.imageBase64;
          }
        })
        .catch(err => console.error('‚ùå Failed to fetch council details:', err));
    }


    /* --------------------------------------
         üîπ Render chunks (3 reports per page)
       -------------------------------------- */
    function renderAssessmentChunks(data) {
      const grouped = data.reduce((acc, prop) => {
        const key = prop.propertyDetails?.pdNewpropertynoVc;
        if (!acc[key]) acc[key] = [];
        acc[key].push(prop);
        return acc;
      }, {});

      const reportContainer = document.querySelector("#reportContainer");
      reportContainer.innerHTML = "";
      const groups = Object.values(grouped);

      // --- DYNAMIC HEADER GENERATION ---
      const taxConfigs = window.dynamicTaxConfigs || [];
      // +1 for '‡§è‡§ï‡•Ç‡§£' (Total) column
      const taxColSpan = taxConfigs.length + 1;

      // Helper to generate dynamic tax headers
      const createTaxHeaders = (className) => {
        return taxConfigs.map(c => {
          // Use vertical class 'v' if name is long
          const vClass = c.localNameVc.length > 5 ? 'v' : '';
          return `<th class="${className} ${vClass}">${c.localNameVc}</th>`;
        }).join('');
      };

      const p1TaxHeaders = createTaxHeaders('p1');
      const p2HearingHeaders = createTaxHeaders('p2');
      const p2AppealHeaders = createTaxHeaders('p2');

      // Header HTML to clone each time
      const councilHeaderHTML = document.querySelector("#mainHeader").outerHTML;

      const tableHeadHTML = `
        <thead>
          <tr>
            <th class="p1" rowspan="3" >‡§ï‡•ç‡§∞.</th>
            <th class="p1 v" rowspan="3">‡§∞‡§∏‡•ç‡§§‡§æ,<br>‡§µ‡§ø‡§≠‡§æ‡§ó,<br>‡§Æ‡§Ç‡§°‡§≥‡§æ‡§ö‡•á ‡§®‡§æ‡§µ ‡§µ ‡§µ‡§æ‡§° ‡§ï‡•ç‡§∞.</th>
            <th class="p1 v" rowspan="3">‡§ù‡•ã‡§® ‡§ï‡•ç‡§∞.<br>(‡§®‡§µ‡•Ä‡§® / ‡§ú‡•Å‡§®‡§æ)</th>
            <th class="p1 v" rowspan="3">‡§Æ‡§æ‡§≤‡§Æ‡§§‡•ç‡§§‡§æ ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï<br>(‡§®‡§µ‡•Ä‡§® / ‡§ú‡•Å‡§®‡§æ / ‡§∏‡§π. ‡§Æ‡§æ. ‡§®‡§Ç.)</th>
            <th class="p1 " rowspan="3">‡§Æ‡§æ‡§≤‡§ï‡§æ‡§ö‡•á ‡§®‡§æ‡§µ</th>
            <th class="p1" rowspan="3">‡§≠‡•ã‡§ó‡§µ‡§ü‡§æ‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§®‡§æ‡§µ</th>
            <th class="p1 group" colspan="3">‡§Æ‡§æ‡§≤‡§Æ‡§§‡•ç‡§§‡•á‡§ö‡•á ‡§µ‡§∞‡•ç‡§£‡§®</th>
            <th class="p1 v" rowspan="3">‡§Æ‡§æ‡§≤‡§Æ‡§§‡•ç‡§§‡•á‡§ö‡•á ‡§Ö‡§Ç‡§¶‡§æ‡§ú‡§ø‡§§ ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§≠‡§æ‡§°‡•á ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th>
            <th class="p1 v" rowspan="3">‡§≠‡§æ‡§°‡•ç‡§Ø‡§æ‡§®‡•á ‡§¶‡§ø‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§≠‡§æ‡§ó‡§æ‡§ö‡•á ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§≠‡§æ‡§°‡•á</th>
            <th class="p1 v" rowspan="3">‡§≠‡§æ‡§°‡•ç‡§Ø‡§æ‡§®‡•á ‡§® ‡§¶‡§ø‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§≠‡§æ‡§ó‡§æ‡§ö‡•á ‡§Ö‡§Ç‡§¶‡§æ‡§ú‡§ø‡§§ ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§≠‡§æ‡§°‡•á</th>
            <th class="p1 v" rowspan="3">‡§á‡§Æ‡§æ‡§∞‡§§‡•Ä‡§ö‡•á ‡§µ‡§æ ‡§ú‡§Æ‡§ø‡§®‡•Ä‡§ö‡•á ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§≠‡§æ‡§°‡•á</th>
            <th class="p1 v" rowspan="3">‡§¶‡•Å‡§∞‡•Å‡§∏‡•ç‡§§‡•Ä ‡§á‡§§‡•ç‡§Ø‡§æ‡§¶‡•Ä ‡§∏‡§æ‡§†‡•Ä 10% ‡§µ‡§ú‡§æ‡§µ‡§ü</th>
            <th class="p1 v" rowspan="3">‡§á‡§Æ‡§æ‡§∞‡§§‡•Ä‡§ö‡•á ‡§µ‡§æ ‡§ú‡§Æ‡§ø‡§®‡•Ä‡§ö‡•á ‡§ï‡§∞‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th>
            <th class="p1 group" colspan="${taxColSpan}">‡§Ü‡§ï‡§æ‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ü‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§ï‡§∞‡§æ‡§Ç‡§ö‡•Ä ‡§∞‡§ï‡•ç‡§ï‡§Æ (‡§∏‡•Å‡§®‡§æ‡§µ‡§£‡•Ä ‡§Ü‡§ß‡•Ä‡§ö‡•á)</th>
            <th class="seam" rowspan="3"></th>
            <th class="p2 group" colspan="${taxColSpan}">‡§Ü‡§ï‡§æ‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ø‡•á‡§£‡§æ‡§±‡•ç‡§Ø‡§æ ‡§ï‡§∞‡§æ‡§Ç‡§ö‡•Ä ‡§∞‡§ï‡•ç‡§ï‡§Æ (‡§Ü‡§ï‡•ç‡§∑‡•á‡§™ / ‡§∏‡•Å‡§®‡§æ‡§µ‡§£‡•Ä ‡§®‡§Ç‡§§‡§∞‡§ö‡•á)</th>
            <th class="p2 group" colspan="${taxColSpan}">‡§Ü‡§ï‡§æ‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ü‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§ï‡§∞‡§æ‡§Ç‡§ö‡•ç‡§Ø‡§æ ‡§∞‡§ï‡§Æ (‡§Ö‡§™‡•Ä‡§≤ ‡§®‡§Ç‡§§‡§∞)</th>
            <th class="p2" rowspan="3">‡§Ü‡§ï‡•ç‡§∑‡•á‡§™‡§æ‡§¨‡§æ‡§¨‡§§</th>
            <th class="p2" rowspan="3">‡§∏‡•Å‡§®‡§æ‡§µ‡§£‡•Ä ‡§®‡§ø‡§ï‡§æ‡§≤</th>
            <th class="p2" rowspan="3">‡§Ö‡§ß‡§ø‡§ï‡•É‡§§ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§£ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä‡§ö‡•Ä ‡§∏‡§π‡•Ä</th>
            <th class="p2" rowspan="3">‡§Ö‡§™‡•Ä‡§≤ ‡§∏‡§Æ‡§ø‡§§‡•Ä ‡§∏‡§≠‡§æ‡§™‡§§‡•Ä‡§ö‡•Ä ‡§∏‡§π‡•Ä</th>
            <th class="p2" rowspan="3">‡§´‡•á‡§∞‡§´‡§æ‡§∞ ‡§¨‡§Å‡§≤‡§ö‡§æ ‡§∂‡•á‡§∞‡§æ ‡§µ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§π‡•Ä</th>
            <th class="p2 v" rowspan="3">‡§µ‡§æ‡§™‡§∞ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ / ‡§Æ‡§ú‡§≤‡§æ / ‡§Æ‡§æ‡§≤‡§ï, ‡§≠‡§æ‡§°‡•á‡§ï‡§∞‡•Ç</th>
          </tr>
          <tr>
            <th class="p1 v">‡§µ‡§æ‡§™‡§∞ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ / ‡§Æ‡§ú‡§≤‡§æ / ‡§Æ‡§æ‡§≤‡§ï / ‡§≠‡§æ‡§°‡•á‡§ï‡§∞‡•Ç</th>
            <th class="p1 v">‡§¨‡§æ‡§Ç‡§ß‡§ï‡§æ‡§Æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ / ‡§ï‡§∞‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≥</th>
            <th class="p1 v">‡§è‡§ï‡•Ç‡§£ ‡§ï‡§∞‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≥</th>

            <!-- P1: Dynamic Tax Headers -->
            ${p1TaxHeaders}
            <th class="p1">‡§è‡§ï‡•Ç‡§£</th>

            <!-- P2 Hearing: Dynamic Tax Headers -->
            ${p2HearingHeaders}
            <th class="p2">‡§è‡§ï‡•Ç‡§£</th>

            <!-- P2 Appeal: Dynamic Tax Headers -->
            ${p2AppealHeaders}
            <th class="p2">‡§è‡§ï‡•Ç‡§£</th>
          </tr>
        </thead>
      `;

      // --- DYNAMIC COLUMN NUMBERS ---
      // MODIFIED: Generate empty <th> tags with correct classes. CSS counters will add numbers.
      let colNum = 1;
      const staticCols1 = Array(15).fill(0).map(() => `<th class="p1"></th>`).join('');
      const p1TaxCols = Array(taxColSpan).fill(0).map(() => `<th class="p1"></th>`).join('');
      const seamCol = '<th class="seam"></th>'; // MODIFIED: Added seam class
      const p2HearingCols = Array(taxColSpan).fill(0).map(() => `<th class="p2"></th>`).join('');
      const p2AppealCols = Array(taxColSpan).fill(0).map(() => `<th class="p2"></th>`).join('');
      const staticCols2 = Array(6).fill(0).map(() => `<th class="p2"></th>`).join('');

      // üîπ MODIFIED: Calculate P1 column count and set P2 counter to start from there.
      const p1ColCount = 15 + taxColSpan;
      const columnNumbersHTML = `<tr class="column-numbers" style="counter-reset: counterP1 0 counterP2 ${p1ColCount};">${staticCols1}${p1TaxCols}${seamCol}${p2HearingCols}${p2AppealCols}${staticCols2}</tr>`;
      // --- END DYNAMIC HEADERS ---


      let chunkIndex = 0;
      for (let i = 0; i < groups.length; i += 3) {
        chunkIndex++;
        const chunk = groups.slice(i, i + 3);
        const wrapper = document.createElement("div");

        // only add council header from 2nd chunk onwards
        wrapper.innerHTML = `
          ${chunkIndex === 1 ? "" : councilHeaderHTML}
          <table class="reportTable">${tableHeadHTML}${columnNumbersHTML}<tbody></tbody></table>
        `;
        const tbody = wrapper.querySelector("tbody");

        chunk.forEach((group, idx) => {
          const property = group[0];
          const pd = property.propertyDetails || {};
          const usages = (group.flatMap(p => p.propertyUnitDetails || [])).map(u => u.usageTypeVc || "").join("<br>");
          const beforeAll = group.map(p => p.taxKeyValueMapAfterAssess || {});
          const afterAll = group.map(p => p.taxKeyValueMapAfterHearing || {});

          const mergeTaxMaps = (arr) => {
            const total = {};
            arr.forEach(m => {
              for (const [k, v] of Object.entries(m)) {
                total[k] = (total[k] || 0) + (parseFloat(v) || 0);
              }
            });
            return total;
          };

          const before = mergeTaxMaps(beforeAll);
          const after = mergeTaxMaps(afterAll);

          // Calculate totals dynamically
          const totalBefore = taxConfigs.reduce((sum, tax) => sum + (before[tax.taxMasterIdI] || 0), 0);
          const totalAfter = taxConfigs.reduce((sum, tax) => sum + (after[tax.taxMasterIdI] || 0), 0);

          // --- DYNAMIC DATA ROW GENERATION ---
          const p1TaxData = taxConfigs.map(c =>
            `<td class="p1">${before[c.taxMasterIdI] || 0}</td>`
          ).join('');

          const p2HearingData = taxConfigs.map(c =>
            `<td class="p2">${after[c.taxMasterIdI] || 0}</td>`
          ).join('');

          // Appeal taxes are empty in the original logic, so we just generate empty cells
          const p2AppealData = taxConfigs.map(() => `<td class="p2"></td>`).join('');
          // --- END DYNAMIC DATA ---


          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="p1">${i + idx + 1}</td>
            <td class="p1">${pd.pdWardI || ""}</td>
            <td class="p1">${pd.pdZoneI || ""}</td>
            <td class="p1 property-no">
                  ${[pd.pdNewpropertynoVc || '', pd.pdFinalpropnoVc || '', pd.pdSurypropnoVc || '']
                    .filter(v => v && v.trim() !== '')
                    .join('<br>')}
            </td>
            <td class="p1">${pd.pdOwnernameVc || "‚Äî"}</td>
            <td class="p1">${pd.pdOccupinameF || "‚Äî"}</td>
            <td class="p1 multi-line">
                  ${[
                    property.propertyTypeVc || "‚Äî",
                    property.usageTypeVc || "‚Äî",
                    property.floorNoVc || "‚Äî",
                    property.ownerTypeVc || "‚Äî"
                  ].filter(v => v && v.trim() !== "").join("<br>")}
            </td>
            <td class="p1"></td>
            <td class="p1"></td>
            <td class="p1">${before["ratepersqm"] || ""}</td>
            <td class="p1">${before["actualrent"] || ""}</td>
            <td class="p1">${before["ratablevalue"] || ""}</td>
            <td class="p1">${before["amountafterdep"] || ""}</td>
            <td class="p1">${before["depamount"] || ""}</td>
            <td class="p1">${before["totalratablevalue"] || ""}</td>

            <!-- P1: Dynamic Tax Data -->
            ${p1TaxData}
            <td class="p1"><b>${totalBefore.toFixed(0)}</b></td>

            <td class="seam"></td>

            <!-- P2 Hearing: Dynamic Tax Data -->
            ${p2HearingData}
            <td class="p2"><b>${totalAfter.toFixed(0)}</b></td>

            <!-- P2 Appeal: Dynamic (empty) Tax Data -->
            ${p2AppealData}
            <td class="p2"></td> <!-- Appeal Total (empty) -->

            <!-- Static P2 Columns (Fixed Bug) -->
            <td class="p2"></td> <!-- ‡§Ü‡§ï‡•ç‡§∑‡•á‡§™‡§æ‡§¨‡§æ‡§¨‡§§ -->
            <td class="p2"></td> <!-- ‡§∏‡•Å‡§®‡§æ‡§µ‡§£‡•Ä ‡§®‡§ø‡§ï‡§æ‡§≤ -->
            <td class="p2"></td> <!-- ‡§Ö‡§ß‡§ø‡§ï‡•É‡§§ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§£ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä‡§ö‡•Ä ‡§∏‡§π‡•Ä -->
            <td class="p2"></td> <!-- ‡§Ö‡§™‡•Ä‡§≤ ‡§∏‡§Æ‡§ø‡§§‡•Ä ‡§∏‡§≠‡§æ‡§™‡§§‡•Ä‡§ö‡•Ä ‡§∏‡§π‡•Ä -->
            <td class="p2"></td> <!-- ‡§´‡•á‡§∞‡§´‡§æ‡§∞ ‡§¨‡§Å‡§≤‡§ö‡§æ ‡§∂‡•á‡§∞‡§æ ‡§µ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§π‡•Ä -->
            <td class="p2">${usages}</td> <!-- ‡§µ‡§æ‡§™‡§∞ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ -->
          `;
          tbody.appendChild(tr);

        // Add placeholder rows (assuming 3 rows per property)
          const tr1 = document.createElement("tr");
          tr1.innerHTML = `<td class="p1" colspan="${15 + taxColSpan}"></td> <td class="seam"></td> <td class="p2" colspan="${taxColSpan + taxColSpan + 6}"></td>`;
          tbody.appendChild(tr1);

            const tr2 = document.createElement("tr");
          tr2.innerHTML = `<td class="p1" colspan="${15 + taxColSpan}"></td> <td class="seam"></td> <td class="p2" colspan="${taxColSpan + taxColSpan + 6}"></td>`;
          tbody.appendChild(tr2);
        });

        // Page break style after each chunk
        wrapper.style.pageBreakAfter = "always";
        reportContainer.appendChild(wrapper);
      }
    }

    /* print logic */
    function printPart(part) {
      document.body.classList.remove('print1','print2');
      document.body.classList.add(part === 1 ? 'print1' : 'print2');
      window.print();
      setTimeout(() => document.body.classList.remove('print1','print2'), 400);
    }
</script>
</body>
</html>

